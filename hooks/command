#!/bin/bash
set -exuo pipefail

DIR="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"

# shellcheck disable=SC1090,SC1091
. "$DIR/../lib/shared.bash"

job_image_name="$(plugin_read_config VM_NAME)-${BUILDKITE_JOB_ID}"

run_args=()

# Inherit environment variables from host
# shellcheck disable=SC2091
if $(plugin_read_config INHERIT_ENVIRONMENT_VARS false) ; then
  run_args+=("--env")
fi

# Provide an environment variable file
if [[ -n $(plugin_read_config ENVIRONMENT_FILE) ]] ; then
  run_args+=("--env-file" "$(plugin_read_config ENVIRONMENT_FILE)")
fi

run_args+=("$job_image_name")

# Wait for sntp to update VM time (anka run has no --wait-time; we sleep inside the VM)
wait_time_seconds="$(plugin_read_config WAIT_TIME)"

copy_in_host_path="$(plugin_read_config COPY_IN_HOST_PATH)"
copy_in_vm_path="$(plugin_read_config COPY_IN_VM_PATH)"
copy_out_vm_path="$(plugin_read_config COPY_OUT_VM_PATH)"
copy_out_host_path="$(plugin_read_config COPY_OUT_HOST_PATH)"

if [[ -n "$copy_in_host_path" && -z "$copy_in_vm_path" ]] || [[ -z "$copy_in_host_path" && -n "$copy_in_vm_path" ]]; then
  echo "Both copy-in-host-path and copy-in-vm-path are required together."
  exit 1
fi

if [[ -n "$copy_out_vm_path" && -z "$copy_out_host_path" ]] || [[ -z "$copy_out_vm_path" && -n "$copy_out_host_path" ]]; then
  echo "Both copy-out-vm-path and copy-out-host-path are required together."
  exit 1
fi

if [[ -n "$copy_in_host_path" ]]; then
  echo "--- :anka: Copying ${copy_in_host_path} to ${job_image_name}:${copy_in_vm_path}"
  # shellcheck disable=SC2086
  plugin_prompt_and_run anka $ANKA_DEBUG cp -a "$copy_in_host_path" "${job_image_name}:${copy_in_vm_path}"
fi

if [[ -z "${BUILDKITE_JOB_ID:-}" ]]; then
  echo "BUILDKITE_JOB_ID must be set in order to run buildkite-agent bootstrap."
  exit 1
fi

bootstrap_args=("--job" "$BUILDKITE_JOB_ID")

add_bootstrap_arg_if_set() {
  local environment_variable_name="$1"
  local bootstrap_flag="$2"
  local bootstrap_value="${!environment_variable_name:-}"
  if [[ -n "$bootstrap_value" ]]; then
    bootstrap_args+=("$bootstrap_flag" "$bootstrap_value")
  fi
}

add_bootstrap_arg_if_set "BUILDKITE_COMMAND" "--command"
add_bootstrap_arg_if_set "BUILDKITE_REPO" "--repository"
add_bootstrap_arg_if_set "BUILDKITE_COMMIT" "--commit"
add_bootstrap_arg_if_set "BUILDKITE_BRANCH" "--branch"
add_bootstrap_arg_if_set "BUILDKITE_TAG" "--tag"
add_bootstrap_arg_if_set "BUILDKITE_REFSPEC" "--refspec"
add_bootstrap_arg_if_set "BUILDKITE_PLUGINS" "--plugins"
add_bootstrap_arg_if_set "BUILDKITE_PULL_REQUEST" "--pullrequest"
add_bootstrap_arg_if_set "BUILDKITE_AGENT_NAME" "--agent"
add_bootstrap_arg_if_set "BUILDKITE_AGENT_META_DATA_QUEUE" "--queue"
add_bootstrap_arg_if_set "BUILDKITE_ORGANIZATION_SLUG" "--organization"
add_bootstrap_arg_if_set "BUILDKITE_PIPELINE_SLUG" "--pipeline"
add_bootstrap_arg_if_set "BUILDKITE_PIPELINE_PROVIDER" "--pipeline-provider"
add_bootstrap_arg_if_set "BUILDKITE_ARTIFACT_PATHS" "--artifact-upload-paths"
add_bootstrap_arg_if_set "BUILDKITE_ARTIFACT_UPLOAD_DESTINATION" "--artifact-upload-destination"
add_bootstrap_arg_if_set "BUILDKITE_BUILD_PATH" "--build-path"
add_bootstrap_arg_if_set "BUILDKITE_HOOKS_PATH" "--hooks-path"
add_bootstrap_arg_if_set "BUILDKITE_ADDITIONAL_HOOKS_PATHS" "--additional-hooks-paths"
add_bootstrap_arg_if_set "BUILDKITE_PLUGINS_PATH" "--plugins-path"

# anka run has no --wait-time; when wait-time is enabled, sleep in the VM for sntp to sync
if [[ -n "$wait_time_seconds" ]] && [[ "$wait_time_seconds" =~ ^(true|on|1)$ ]]; then
  wait_time_seconds=10
elif [[ -n "$wait_time_seconds" ]] && [[ "$wait_time_seconds" =~ ^[0-9]+$ ]]; then
  : # use configured seconds
else
  wait_time_seconds=
fi

if [[ -n "$wait_time_seconds" ]]; then
  echo "--- :anka: Waiting ${wait_time_seconds}s for VM time sync"
  # shellcheck disable=SC2086
  plugin_prompt_and_run anka $ANKA_DEBUG run "${run_args[@]:+${run_args[@]}}" sleep "$wait_time_seconds"
fi

# Ensure buildkite-agent exists in VM; if not, copy from host to /usr/local/bin
set +e
# shellcheck disable=SC2086
vm_agent_path=$(anka $ANKA_DEBUG run "${run_args[@]:+${run_args[@]}}" bash -c 'command -v buildkite-agent' 2>/dev/null)
set -e
if [[ -z "$vm_agent_path" ]]; then
  host_agent_path="$(command -v buildkite-agent 2>/dev/null || true)"
  if [[ -z "$host_agent_path" ]] || [[ ! -f "$host_agent_path" ]]; then
    echo "buildkite-agent not found on host (checked PATH); cannot copy into VM." >&2
    exit 1
  fi
  echo "--- :anka: buildkite-agent not in VM; copying from host ($host_agent_path) to /usr/local/bin" >&2
  # shellcheck disable=SC2086
  plugin_prompt_and_run anka $ANKA_DEBUG cp -a "$host_agent_path" "${job_image_name}:/usr/local/bin/buildkite-agent"
fi

echo "+++ Executing buildkite-agent bootstrap in $job_image_name"
set +e
# shellcheck disable=SC2086
plugin_prompt_and_run anka $ANKA_DEBUG run "${run_args[@]:+${run_args[@]}}" buildkite-agent bootstrap "${bootstrap_args[@]:+${bootstrap_args[@]}}"
bootstrap_exit_code=$?
set -e

copy_out_exit_code=0
if [[ -n "$copy_out_vm_path" ]]; then
  echo "--- :anka: Copying ${job_image_name}:${copy_out_vm_path} to ${copy_out_host_path}"
  set +e
  # shellcheck disable=SC2086
  plugin_prompt_and_run anka $ANKA_DEBUG cp -a "${job_image_name}:${copy_out_vm_path}" "$copy_out_host_path"
  copy_out_exit_code=$?
  set -e
fi

if [[ "$bootstrap_exit_code" -ne 0 ]]; then
  exit "$bootstrap_exit_code"
fi

if [[ "$copy_out_exit_code" -ne 0 ]]; then
  exit "$copy_out_exit_code"
fi
